<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Đặt lịch khám nha khoa</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f6f8fa;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        h1 {
            color: #2c3e50;
            margin-top: 40px;
        }
        form {
            background: #fff;
            padding: 32px 28px 24px 28px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(44,62,80,0.08);
            margin-top: 24px;
            min-width: 320px;
        }
        label {
            display: block;
            margin-bottom: 16px;
            color: #34495e;
            font-size: 15px;
        }
        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="email"],
        select,
        textarea {
            width: 100%;
            padding: 8px 10px;
            margin-top: 4px;
            border: 1px solid #d0d7de;
            border-radius: 4px;
            font-size: 15px;
            box-sizing: border-box;
            background: #f9fafb;
        }
        button[type="submit"] {
            background: #3498db;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 10px 24px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 8px;
            transition: background 0.2s;
        }
        button[type="submit"]:hover {
            background: #217dbb;
        }
        #bookingResult {
            margin-top: 18px;
            font-size: 15px;
            color: #e74c3c;
            min-height: 20px;
        }
    </style>
</head>
<body>
<h1>Đặt lịch khám nha khoa</h1>
<form id="bookingForm">
    <label>Họ tên: <input type="text" name="fullName" required maxlength="200"></label><br>
    <label>Email: <input type="email" name="email" required maxlength="200"></label><br>
    <label>Số điện thoại: <input type="text" name="phone" required maxlength="30"></label><br>
    <label>Dịch vụ: <select name="serviceId" id="serviceSelect" required><option value="">Đang tải...</option></select></label><br>
    <label>Bác sĩ (tuỳ chọn): <select name="dentistId" id="dentistSelect"><option value="">Không chọn</option></select></label><br>
    <label>Ngày hẹn: <input type="date" id="dateInput" required></label><br>
    <label>Giờ hẹn: <input type="time" id="timeInput" required></label><br>
    <label>Ghi chú: <textarea name="notes" maxlength="2000"></textarea></label><br>
    <button type="submit">Đặt lịch</button>
</form>
<div id="bookingResult"></div>
<script>
// Populate services and dentists
async function loadOptions() {
    try {
        const svcResp = await fetch('/api/services');
        if (svcResp.ok) {
            const json = await svcResp.json();
            const services = (json && json.data) ? json.data : json;
            const sel = document.getElementById('serviceSelect');
            sel.innerHTML = '<option value="">--Chọn dịch vụ--</option>';
            if (Array.isArray(services)) {
                services.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.name || s.title || (`Dịch vụ ${s.id}`);
                    sel.appendChild(opt);
                });
            } else {
                sel.innerHTML = '<option value="">Không có dịch vụ</option>';
            }
         } else {
             document.getElementById('serviceSelect').innerHTML = '<option value="">Không tải được dịch vụ</option>';
         }
     } catch (ex) {
        console.error('Error loading services', ex);
        document.getElementById('serviceSelect').innerHTML = '<option value="">Lỗi tải dịch vụ</option>';
     }

     try {
         const dentResp = await fetch('/api/dentists');
         if (dentResp.ok) {
            const json = await dentResp.json();
            const dentists = (json && json.data) ? json.data : json;
            const sel = document.getElementById('dentistSelect');
            sel.innerHTML = '<option value="">Không chọn</option>';
            if (Array.isArray(dentists)) {
                dentists.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.id;
                    opt.textContent = d.fullName || d.name || (`Bác sĩ ${d.id}`);
                    sel.appendChild(opt);
                });
            }
         }
     } catch (ex) {
        console.error('Error loading dentists', ex);
     }
}

document.addEventListener('DOMContentLoaded', loadOptions);

document.getElementById('bookingForm').onsubmit = async function(e) {
    e.preventDefault();
    const form = document.getElementById('bookingForm');
    const formData = new FormData(form);
    // build payload matching QuickBookingRequest DTO
    const payload = {
        fullName: formData.get('fullName'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        serviceId: formData.get('serviceId') ? Number(formData.get('serviceId')) : null,
        // convert date input (yyyy-mm-dd) to MM/dd/yyyy expected by backend
        date: (function(){
            const v = document.getElementById('dateInput').value;
            if (!v) return '';
            const parts = v.split('-'); // yyyy-mm-dd
            return parts.length===3? (parts[1] + '/' + parts[2] + '/' + parts[0]) : v;
        })(),
        time: (function(){
            // ensure HH:mm format
            const t = document.getElementById('timeInput').value;
            return t || '';
        })(),
        dentistId: formData.get('dentistId') ? Number(formData.get('dentistId')) : null,
        notes: formData.get('notes') || ''
    };

    // Basic client-side validation for required fields expected by server
    if (!payload.fullName || !payload.email || !payload.phone || !payload.serviceId || !payload.date || !payload.time) {
        document.getElementById('bookingResult').innerText = 'Vui lòng điền đủ thông tin bắt buộc.';
        return;
    }

    const response = await fetch('/api/public/quick-booking', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
    const result = await response.json();
    document.getElementById('bookingResult').innerText = result.message || JSON.stringify(result);
};
</script>
</body>
</html>
